#!/bin/bash

# Скрипт для обновления и перезапуска сервера
# Использование: ./build-app.sh

# Цвета для вывода
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Начинаем процесс обновления сервера...${NC}"

# Шаг 1: Получаем последние изменения из репозитория
echo -e "${YELLOW}1. Получаем последние изменения из репозитория...${NC}"
git pull
if [ $? -ne 0 ]; then
    echo -e "${RED}Ошибка при получении изменений из репозитория!${NC}"
    exit 1
fi
echo -e "${GREEN}Изменения успешно получены.${NC}"

# Шаг 2: Устанавливаем зависимости
echo -e "${YELLOW}2. Устанавливаем зависимости...${NC}"
pnpm install
if [ $? -ne 0 ]; then
    echo -e "${RED}Ошибка при установке зависимостей!${NC}"
    exit 1
fi
echo -e "${GREEN}Зависимости успешно установлены.${NC}"

# Шаг 3: Применяем миграции базы данных
echo -e "${YELLOW}3. Применяем миграции базы данных...${NC}"
npx prisma migrate deploy
if [ $? -ne 0 ]; then
    echo -e "${RED}Ошибка при применении миграций!${NC}"
    exit 1
fi
echo -e "${GREEN}Миграции успешно применены.${NC}"

# Шаг 4: Собираем проект
echo -e "${YELLOW}4. Собираем проект...${NC}"
npm run build
if [ $? -ne 0 ]; then
    echo -e "${RED}Ошибка при сборке проекта!${NC}"
    exit 1
fi
echo -e "${GREEN}Проект успешно собран.${NC}"

# Шаг 5: Перезапускаем сервер через PM2
echo -e "${YELLOW}5. Перезапускаем сервер...${NC}"
pm2 restart myach-pro-server
if [ $? -ne 0 ]; then
    echo -e "${RED}Ошибка при перезапуске сервера!${NC}"
    exit 1
fi
echo -e "${GREEN}Сервер успешно перезапущен.${NC}"

# Шаг 6: Выводим логи сервера
echo -e "${YELLOW}6. Выводим последние логи сервера (Ctrl+C для выхода):${NC}"
pm2 logs myach-pro-server --lines 20

echo -e "${GREEN}Процесс обновления сервера успешно завершен!${NC}" 