import { Request, Response } from 'express';
import {
	imageGenerationService,
	ShareImageData,
} from '../services/imageGeneration.service';
import TelegramBot from 'node-telegram-bot-api';
import { initDataUtils } from '../utils/initDataUtils';
import { config } from '../config/env';
import { Readable } from 'stream';
import fs from 'fs';
import path from 'path';
import { logger } from '../utils/logger';

/**
 * –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π —à–∞—Ä–∏–Ω–≥–∞
 */
export class ShareController {
	private bot: TelegramBot;

	constructor() {
		this.bot = new TelegramBot(config.telegram.botToken);
	}

	/**
	 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ Telegram
	 */
	public shareResults = async (req: Request, res: Response) => {
		let userId: number | undefined; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤ catch

		try {
			const { shareData, telegramUser } = req.body; // telegramUser –∏–∑ middleware

			// –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
			console.log('üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ shareResults:');
			console.log('üì¶ shareData –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç:', !!shareData);
			console.log('üë§ telegramUser –∏–∑ middleware:', telegramUser);
			console.log('üÜî telegramUser.id:', telegramUser?.id);
			console.log('üìã Headers Authorization:', req.headers.authorization);
			console.log('üìã req.body keys:', Object.keys(req.body));

			if (!shareData) {
				res.status(400).json({
					error: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è',
				});
				return;
			}

			if (!telegramUser || !telegramUser.id) {
				console.error('‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ middleware');
				console.error('üìã –ü–æ–ª–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏:', req.headers);
				console.error('üë§ –û–±—ä–µ–∫—Ç telegramUser:', telegramUser);
				console.error('üì¶ req.body:', req.body);

				res.status(400).json({
					error: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
					debug: {
						hasTelegramUser: !!telegramUser,
						userId: telegramUser?.id,
						hasAuthHeader: !!req.headers.authorization,
						bodyKeys: Object.keys(req.body),
					},
				});
				return;
			}

			userId = telegramUser.id;

			// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
			const imageData: ShareImageData = {
				categorizedPlayerIds: shareData.categorizedPlayerIds,
				categories: shareData.categories,
				clubId: shareData.clubId,
			};

			// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Ç–µ–º–∏ –∂–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —á—Ç–æ –∏ –¥–ª—è iOS
			console.log('üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è Android —Å –≤—ã—Å–æ–∫–∏–º –∫–∞—á–µ—Å—Ç–≤–æ–º');
			const { imageBuffer, club } =
				await imageGenerationService.generateResultsImage(imageData, {
					quality: 98, // –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –∫–∞–∫ –¥–ª—è iOS
					width: 550, // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫
					height: 800, // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
					optimizeForSpeed: false, // –í–ê–ñ–ù–û: –æ—Ç–∫–ª—é—á–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–æ–∫
				});

			// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
			const imageSizeMB = imageBuffer.length / (1024 * 1024);
			console.log(
				`–†–∞–∑–º–µ—Ä —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${imageSizeMB.toFixed(2)} MB`,
			);

			if (imageSizeMB > 10) {
				console.warn(
					'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ, –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ',
				);
			}

			// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram
			const caption = `üèÜ –¢–ò–†-–õ–ò–°–¢ "${club.name.toUpperCase()}"\n\n‚öΩ –°–æ–∑–¥–∞–Ω–æ –≤ @${
				config.telegram.botUsername
			}`;

			try {
				// –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –±–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
				if (!this.bot) {
					throw new Error('Telegram –±–æ—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
				}

				// –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ userId –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
				if (!userId) {
					throw new Error('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
				}

				console.log(
					`üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userId}`,
				);
				console.log(`üìù –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${imageBuffer.length} –±–∞–π—Ç`);
				console.log(`ü§ñ –ë–æ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω: ${!!this.bot}`);

				// –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ Stream (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–±)
				const imageStream = new Readable({
					read() {},
				});
				imageStream.push(imageBuffer);
				imageStream.push(null);

				const result = await this.bot.sendPhoto(userId, imageStream, {
					caption,
					reply_markup: {
						inline_keyboard: [
							[
								{
									text: '–û—Ç–∫—Ä—ã—Ç—å –¢–∏—Ä –õ–∏—Å—Ç',
									web_app: { url: config.webApp.url },
								},
							],
						],
					},
				});

				console.log(
					`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ Stream, message_id: ${result.message_id}`,
				);
			} catch (streamError) {
				console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ Stream:', {
					error:
						streamError instanceof Error
							? streamError.message
							: String(streamError),
					userId,
					imageSize: imageBuffer.length,
				});

				console.warn('üîÑ –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª...');

				// Fallback: —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
				const tempFileName = `tier-list-${userId}-${Date.now()}.jpg`;
				const tempFilePath = path.join(
					process.cwd(),
					'tmp',
					'uploads',
					tempFileName,
				);

				// –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
				await fs.promises.writeFile(tempFilePath, imageBuffer);
				console.log(`üíæ –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω: ${tempFilePath}`);

				try {
					// –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ userId –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —á–µ—Ä–µ–∑ —Ñ–∞–π–ª
					if (!userId) {
						throw new Error('ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞');
					}

					// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Ñ–∞–π–ª
					const fileResult = await this.bot.sendPhoto(userId, tempFilePath, {
						caption,
						reply_markup: {
							inline_keyboard: [
								[
									{
										text: '–û—Ç–∫—Ä—ã—Ç—å –¢–∏—Ä –õ–∏—Å—Ç',
										web_app: { url: config.webApp.url },
									},
								],
							],
						},
					});

					console.log(
						`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ —Ñ–∞–π–ª, message_id: ${fileResult.message_id}`,
					);
				} finally {
					// –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
					try {
						await fs.promises.unlink(tempFilePath);
						console.log(`üóëÔ∏è –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω: ${tempFilePath}`);
					} catch (unlinkError) {
						console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª:', {
							file: tempFilePath,
							error:
								unlinkError instanceof Error
									? unlinkError.message
									: String(unlinkError),
						});
					}
				}
			}

			// –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
			res.json({
				success: true,
				message: '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç',
				closeWebApp: true,
			});
		} catch (error) {
			console.error(
				'‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:',
				{
					error: error instanceof Error ? error.message : String(error),
					stack: error instanceof Error ? error.stack : undefined,
					userId,
				},
			);
			res.status(500).json({
				error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞',
			});
		}
	};

	/**
	 * –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—Å–∂–∞—Ç–æ–µ)
	 */
	public previewImage = async (req: Request, res: Response) => {
		try {
			const { categorizedPlayerIds, categories, clubId } = req.body;

			if (!categorizedPlayerIds || !categories || !clubId) {
				res.status(400).json({
					error: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
				});
				return;
			}

			const { imageBuffer } = await imageGenerationService.generateResultsImage(
				{
					categorizedPlayerIds,
					categories,
					clubId,
				},
				{ quality: 75, width: 550, height: 800 }, // –°–∂–∞—Ç–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è –ø—Ä–µ–≤—å—é
			);

			res.set({
				'Content-Type': 'image/jpeg',
				'Content-Length': imageBuffer.length.toString(),
				'Cache-Control': 'no-cache',
			});

			res.send(imageBuffer);
		} catch (error) {
			logger.error(
				'–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:',
				error instanceof Error ? error.message : String(error),
			);
			res.status(500).json({
				error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
			});
		}
	};

	/**
	 * –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è/—à—ç—Ä–∏–Ω–≥–∞
	 */
	public downloadImage = async (req: Request, res: Response) => {
		try {
			const { categorizedPlayerIds, categories, clubId } = req.body;

			if (!categorizedPlayerIds || !categories || !clubId) {
				res.status(400).json({
					error: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã',
				});
				return;
			}

			console.log(
				'üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º',
			);

			const { imageBuffer, club } =
				await imageGenerationService.generateResultsImage(
					{
						categorizedPlayerIds,
						categories,
						clubId,
					},
					{
						quality: 98, // –ï—â–µ –≤—ã—à–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫
						width: 550, // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫
						height: 800, // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞
						optimizeForSpeed: false, // –û—Ç–∫–ª—é—á–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
					},
				);

			// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§–æ—Ä–º–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ ASCII –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∞
			const safeClubName = club.name
				.replace(/[–∞-—è—ë]/gi, (char) => {
					// –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤
					const map: { [key: string]: string } = {
						–∞: 'a',
						–±: 'b',
						–≤: 'v',
						–≥: 'g',
						–¥: 'd',
						–µ: 'e',
						—ë: 'e',
						–∂: 'zh',
						–∑: 'z',
						–∏: 'i',
						–π: 'y',
						–∫: 'k',
						–ª: 'l',
						–º: 'm',
						–Ω: 'n',
						–æ: 'o',
						–ø: 'p',
						—Ä: 'r',
						—Å: 's',
						—Ç: 't',
						—É: 'u',
						—Ñ: 'f',
						—Ö: 'h',
						—Ü: 'c',
						—á: 'ch',
						—à: 'sh',
						—â: 'sch',
						—ä: '',
						—ã: 'y',
						—å: '',
						—ç: 'e',
						—é: 'yu',
						—è: 'ya',
					};
					return map[char.toLowerCase()] || char;
				})
				.replace(/[^a-zA-Z0-9\s]/g, '') // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ ASCII —Å–∏–º–≤–æ–ª—ã –∏ –ø—Ä–æ–±–µ–ª—ã
				.replace(/\s+/g, '-') // –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –Ω–∞ –¥–µ—Ñ–∏—Å—ã
				.toLowerCase()
				.substring(0, 30); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É

			const fileName = `tier-list-${safeClubName || 'club'}.jpg`;
			console.log(`üìÅ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞: ${fileName}`);

			res.set({
				'Content-Type': 'image/jpeg',
				'Content-Length': imageBuffer.length.toString(),
				'Content-Disposition': `attachment; filename="${fileName}"`,
				'Cache-Control': 'private, max-age=3600', // –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ —á–∞—Å
			});

			res.send(imageBuffer);
		} catch (error) {
			logger.error(
				'–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:',
				error instanceof Error ? error.message : String(error),
			);
			res.status(500).json({
				error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
			});
		}
	};
}

export const shareController = new ShareController();
